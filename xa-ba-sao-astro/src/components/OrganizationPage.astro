---
import { COMMUNE_ORG_DATA } from "@/lib/data";
import { UserCircle2, Phone, Mail, Building2, Award, X } from "lucide-react";
import { cn } from "@/lib/utils";

// Fetch org groups from API/DB on the server
let orgGroups = [];
try {
    const { default: OrgGroupModel } = await import('@/models/Organization');
    const { default: mongoose } = await import('mongoose');
    
    const MONGODB_URI = import.meta.env.MONGODB_URI || "mongodb://localhost:27017/xa-ba-sao-portal";
    if (mongoose.connection.readyState === 0) {
        await mongoose.connect(MONGODB_URI);
    }
    
    const groups = await OrgGroupModel.find();
    if (groups && groups.length > 0) {
        orgGroups = groups.map(g => g.toJSON());
    } else {
        orgGroups = COMMUNE_ORG_DATA;
    }
} catch (error) {
    console.error('Fetch org groups error:', error);
    orgGroups = COMMUNE_ORG_DATA;
}
---

<div class="min-h-screen bg-slate-50">
    <section class="relative h-[40vh] min-h-[350px] flex items-center justify-center overflow-hidden bg-slate-900 pt-20">
        <div class="absolute inset-0">
            <img 
                src="https://images.unsplash.com/photo-1541829070764-84a7d30dee62?auto=format&fit=crop&q=80&w=1600" 
                alt="Background" 
                class="w-full h-full object-cover opacity-30"
            />
            <div class="absolute inset-0 bg-gradient-to-br from-primary/20 via-transparent to-black/60"></div>
        </div>

        <div class="container mx-auto px-4 relative z-10 text-center">
            <div class="hero-animate opacity-0 translate-y-4 transition-all duration-700 inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/10 backdrop-blur-md text-white text-sm font-bold border border-white/20 mb-6">
                <Building2 size={16} class="text-primary" />
                Đơn vị hành chính
            </div>
            <h1 class="hero-animate opacity-0 translate-y-4 transition-all duration-700 delay-100 text-4xl md:text-6xl font-black text-white mb-6 tracking-tight">Tổ Chức Bộ Máy</h1>
            <p class="hero-animate opacity-0 translate-y-4 transition-all duration-700 delay-200 text-lg md:text-xl text-white/80 max-w-2xl mx-auto font-medium">Hệ thống chính trị và ban lãnh đạo xã Ba Sao, huyện Cao Lãnh</p>
        </div>
    </section>

    <div class="container mx-auto px-4 py-16 -mt-12 relative z-20">
        <div class="space-y-16">
            {orgGroups.map((group, groupIdx) => (
                <div class="space-y-8">
                    <div class="flex items-center gap-4">
                        <div class="p-3 bg-primary rounded-2xl shadow-lg shadow-primary/20 text-white">
                            <Award size={24} />
                        </div>
                        <div>
                            <h2 class="text-2xl md:text-3xl font-black text-slate-900 tracking-tight">{group.groupName}</h2>
                            <div class="h-1 w-20 bg-primary mt-1 rounded-full"></div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {group.members.map((member, idx) => (
                            <div 
                                class="org-card opacity-0 translate-y-4 transition-all duration-500 bg-white rounded-2xl p-6 border border-slate-100 shadow-xl shadow-slate-200/50 hover:shadow-2xl hover:shadow-primary/10 transition-all group hover:scale-[1.02]"
                                style={`transition-delay: ${idx * 80}ms`}
                            >
                                <div class="flex items-start gap-5">
                                    <div 
                                        class="lightbox-trigger w-[5rem] h-[6.5rem] rounded-xl bg-slate-50 border border-slate-100 flex items-center justify-center overflow-hidden text-slate-300 shadow-sm flex-shrink-0 cursor-pointer hover:opacity-90 transition-opacity"
                                        data-image={member.image}
                                    >
                                        {member.image ? (
                                            <img src={member.image} alt={member.name} class="w-full h-full object-cover" />
                                        ) : (
                                            <div class="flex flex-col items-center justify-center group-hover:text-primary transition-colors">
                                                <UserCircle2 size={32} />
                                            </div>
                                        )}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="px-2 py-0.5 rounded-full bg-primary/10 text-primary text-[10px] font-bold uppercase tracking-wider border border-primary/10">
                                                {member.role}
                                            </span>
                                        </div>
                                        <h3 class="text-lg font-bold text-slate-900 group-hover:text-primary transition-colors mb-3">{member.name}</h3>
                                        
                                        <div class="space-y-2">
                                            {member.phone && (
                                                <a href={`tel:${member.phone}`} class="flex items-center gap-2 text-xs font-bold text-slate-500 hover:text-primary transition-colors bg-slate-50/50 p-2 rounded-lg border border-slate-100/50">
                                                    <Phone size={14} class="text-primary/70" /> {member.phone}
                                                </a>
                                            )}
                                            {member.email && (
                                                <a href={`mailto:${member.email}`} class="flex items-center gap-2 text-xs font-bold text-slate-500 hover:text-primary transition-colors bg-slate-50/50 p-2 rounded-lg border border-slate-100/50">
                                                    <Mail size={14} class="text-primary/70" /> {member.email}
                                                </a>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            ))}
        </div>
    </div>

    {/* Lightbox Modal */}
    <div 
        id="lightbox" 
        class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 opacity-0 pointer-events-none transition-all duration-300"
    >
        <button id="close-lightbox" class="absolute top-4 right-4 p-2 text-white/50 hover:text-white transition-colors">
            <X size={32} />
        </button>
        <img id="lightbox-img" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl object-contain scale-95 transition-transform duration-300" />
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Hero animations
        const heroAnims = document.querySelectorAll('.hero-animate');
        heroAnims.forEach(el => {
            el.classList.remove('opacity-0', 'translate-y-4');
            el.classList.add('opacity-100', 'translate-y-0');
        });

        // Org cards animations
        const orgCards = document.querySelectorAll('.org-card');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    (entry.target as HTMLElement).classList.remove('opacity-0', 'translate-y-4');
                    (entry.target as HTMLElement).classList.add('opacity-100', 'translate-y-0');
                }
            });
        }, { threshold: 0.1 });

        orgCards.forEach(card => observer.observe(card));

        // Setup Lightbox (similar to HamletDetail)
        setupLightbox();
    });

    function setupLightbox() {
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img') as HTMLImageElement;
        const closeBtn = document.getElementById('close-lightbox');
        const triggers = document.querySelectorAll('.lightbox-trigger');

        triggers.forEach(trigger => {
            trigger.addEventListener('click', () => {
                const imgUrl = (trigger as HTMLElement).dataset.image;
                if (imgUrl) {
                    lightboxImg.src = imgUrl;
                    lightbox?.classList.remove('opacity-0', 'pointer-events-none');
                    lightbox?.classList.add('opacity-100', 'pointer-events-auto');
                    setTimeout(() => {
                        lightboxImg.classList.remove('scale-95');
                        lightboxImg.classList.add('scale-100');
                    }, 50);
                }
            });
        });

        const close = () => {
            lightboxImg.classList.remove('scale-100');
            lightboxImg.classList.add('scale-95');
            setTimeout(() => {
                lightbox?.classList.add('opacity-0', 'pointer-events-none');
                lightbox?.classList.remove('opacity-100', 'pointer-events-auto');
            }, 300);
        };

        closeBtn?.addEventListener('click', close);
        lightbox?.addEventListener('click', (e) => {
            if (e.target === lightbox) close();
        });
    }
</script>
